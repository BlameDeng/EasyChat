(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2c584f5b"],{"170d":function(t,e,n){"use strict";n.r(e);var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"conversation"},[n("div",{staticClass:"nav"},[n("e-nav")],1),n("div",{staticClass:"content"},[t.currentId?n("e-dialog"):n("div",{staticClass:"bg"},[n("x-icon",{staticClass:"icon",attrs:{name:"logo-copy"}})],1)],1)])},i=[],a=n("be94"),r=(n("cadf"),n("551c"),n("097d"),n("61e6")),o=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"e-nav"},[t._m(0),t.conversations&&t.conversations.length?t._l(t.conversations,function(t){return n("e-card",{key:t.id,attrs:{conversation:t}})}):t._e()],2)},c=[function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"title"},[n("div",{staticClass:"chat"},[t._v("聊天")])])}],u=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"card",class:{selected:t.conversation.id===t.currentId},on:{click:t.onClick}},[t.target?[n("img",{ref:"img",attrs:{src:2===t.conversation.members.length?t.target.avatar:"https://chatavatar.oss-cn-hangzhou.aliyuncs.com/multiple.png?x-oss-process=style/avatar"},on:{click:t.onAvatar}}),n("div",{staticClass:"content"},[n("div",{staticClass:"name"},[n("span",{staticClass:"nickyname"},[t._v(t._s(2===t.conversation.members.length?t.target.nickyname:t.conversation.name))])]),n("div",{staticClass:"msg"},[t._v("\n                最新消息："+t._s(t.conversation._lastMessageAt&&t.formatTime(t.conversation._lastMessageAt).stamp)+"\n            ")])]),n("transition",{attrs:{name:"fade"}},[n("div",{directives:[{name:"show",rawName:"v-show",value:t.profileVisible,expression:"profileVisible"}],ref:"profile",staticClass:"profile"},[t.target?n("div",{staticClass:"info"},[n("div",{staticClass:"name"},[t._v(t._s(t.target.nickyname))]),n("img",{attrs:{src:t.target.avatar}})]):t._e(),n("div",{staticClass:"action"},[n("x-icon",{staticClass:"icon",attrs:{name:"addto",title:"添加好友"},on:{click:function(e){return e.stopPropagation(),t.onAdd(e)}}})],1)])])]:t._e(),n("div",{directives:[{name:"show",rawName:"v-show",value:t.unread,expression:"unread"}],staticClass:"dot"})],2)},d=[],l=(n("ac6a"),n("2f62")),m=n("4fe3");function v(t){var e=null;e="string"===typeof t?new Date(t):t;var n=f(e),s=f(new Date);return n.date===s.date?{stamp:n.time,con:n.time}:{stamp:n.date,con:n.date+" "+n.time}}function f(t){var e=t.getFullYear(),n=h(t.getMonth()+1),s=h(t.getDate()),i=h(t.getHours()),a=h(t.getMinutes());return{date:e+"/"+n+"/"+s,time:i+":"+a}}function h(t){return t<10?"0"+t:t}var g=v,b={name:"Card",mixins:[],inject:["eventBus"],components:{xIcon:r["a"]},props:{conversation:Object},data:function(){return{formatTime:g,target:null,unread:!1,profileVisible:!1,add:!1}},computed:Object(a["a"])({},Object(l["d"])({user:function(t){return t.user},userInfo:function(t){return t.userInfo},client:function(t){return t.client},currentId:function(t){return t.currentConversationId}})),watch:{profileVisible:function(t){t?document.addEventListener("click",this.handleProfileVisible):document.removeEventListener("click",this.handleProfileVisible)}},created:function(){var t=this;this.eventBus.$on("new-message",this.handleEventBus);var e="";this.conversation.members.forEach(function(n){n!==t.user.id&&(e=n)}),this.getUserInfo({uid:e}).then(function(e){t.target={nickyname:e[0].attributes.nickyname,avatar:e[0].attributes.avatar,uid:e[0].attributes.uid}})},mounted:function(){},beforeDestroy:function(){this.eventBus.$off("new-message",this.handleEventBus),document.removeEventListener("click",this.handleProfileVisible)},methods:Object(a["a"])({},Object(l["c"])(["setCurrentConversationId","setChatTarget","updateConversation","addFriendInfo"]),Object(l["b"])(["getUserInfo","addFriends"]),{onClick:function(t){t.target!==this.$refs.img&&(this.unread=!1,this.setCurrentConversationId(this.conversation.id),this.setChatTarget(this.target))},handleEventBus:function(t,e){e.id===this.conversation.id&&(this.unread=!0,this.updateConversation(e))},onAvatar:function(){this.profileVisible=!0},handleProfileVisible:function(){this.profileVisible=!1},onAdd:function(){var t=this;if(this.profileVisible=!1,!this.add){this.add=!0;var e=JSON.parse(JSON.stringify(this.userInfo.friends));e.indexOf(this.target.uid)>-1?this.add=!1:(e.push(this.target.uid),this.addFriends({friends:e,id:this.userInfo.id}).then(function(e){t.addFriendInfo(t.target.uid),t.add=!1}))}}})},p=b,C=(n("81d6"),n("2877")),_=Object(C["a"])(p,u,d,!1,null,"865267ec",null);_.options.__file="card.vue";var I=_.exports,k={name:"eNav",components:{eCard:I,xIcon:r["a"]},computed:Object(a["a"])({},Object(l["d"])({conversations:function(t){return t.conversations}}))},O=k,w=(n("cd05"),Object(C["a"])(O,o,c,!1,null,"7a247682",null));w.options.__file="nav.vue";var y=w.exports,j=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"e-dialog"},[n("div",{staticClass:"title"},[t.currentCoversation&&2!==t.currentCoversation.members.length?n("span",[t._v(t._s(t.currentCoversation.name))]):t._e(),t.chatTarget&&t.currentCoversation&&2===t.currentCoversation.members.length?n("span",[t._v(t._s(t.chatTarget.nickyname))]):t._e(),t.currentCoversation&&2!==t.currentCoversation.members.length?n("div",{staticClass:"dot"},[n("x-icon",{staticClass:"icon",attrs:{name:"dian"},on:{click:function(e){t.membersVisible=!0}}})],1):t._e()]),t.members&&t.members.length?[n("transition",{attrs:{name:"fade"}},[n("div",{directives:[{name:"show",rawName:"v-show",value:t.membersVisible,expression:"membersVisible"}],staticClass:"mask"},[n("div",{staticClass:"wrapper"},[n("div",{staticClass:"title"},[t._v("\n                        成员列表\n                        "),n("x-icon",{staticClass:"icon",attrs:{name:"close"},on:{click:function(e){t.membersVisible=!1}}})],1),n("ul",{staticClass:"members"},t._l(t.members,function(e){return n("li",{key:e.uid},[n("img",{attrs:{src:e.avatar}}),n("span",{staticClass:"name"},[t._v(t._s(e.nickyname))]),n("span",{staticClass:"button",class:{disabled:t.userInfo.friends.indexOf(e.uid)>-1||e.uid===t.userInfo.uid},attrs:{role:"button"},on:{click:function(n){t.onAdd(e.uid)}}},[t._v("添加好友")])])}))])])])]:t._e(),n("ul",{ref:"ul",staticClass:"conversation"},[t.messages&&t.messages.length&&t.chatTarget?t._l(t.messages,function(e){return n("li",{key:e.id},[n("div",{staticClass:"time"},[t._v(t._s(t.formatTime(e._timestamp).con))]),e.from!==t.user.id?n("div",{staticClass:"from"},[t.members&&t.members.length?n("img",{attrs:{src:t.getAvatar(e.from)}}):n("img",{attrs:{src:t.chatTarget.avatar}}),n("div",{staticClass:"content"},[2!==t.currentCoversation.members.length&&t.members?n("div",{staticClass:"nickyname"},[t._v(t._s(t.getNickyname(e.from)&&t.getNickyname(e.from).nickyname))]):t._e(),n("div",{staticClass:"msg"},[t._v("\n                            "+t._s(e.text)+"\n                        ")])])]):n("div",{staticClass:"to"},[n("div",{staticClass:"content"},[n("div",{staticClass:"msg"},[t._v("\n                            "+t._s(e.text)+"\n                        ")])]),n("img",{attrs:{src:t.userInfo.avatar}})])])}):t._e()],2),n("div",{staticClass:"input"},[n("textarea",{directives:[{name:"model",rawName:"v-model",value:t.msg,expression:"msg"}],domProps:{value:t.msg},on:{input:function(e){e.target.composing||(t.msg=e.target.value)}}}),n("div",{staticClass:"button",attrs:{role:"button"},on:{click:t.send}},[t._v("发送")])])],2)},x=[],E=(n("96cf"),n("1da1")),B=(n("7514"),{name:"eDialog",inject:["eventBus"],components:{xIcon:r["a"]},data:function(){return{formatTime:g,msg:"",messages:null,members:null,getting:!1,membersVisible:!1,add:!1}},computed:Object(a["a"])({},Object(l["d"])({userInfo:function(t){return t.userInfo},user:function(t){return t.user},currentId:function(t){return t.currentConversationId},conversations:function(t){return t.conversations},chatTarget:function(t){return t.chatTarget},client:function(t){return t.client},friendsList:function(t){return t.friendsList}}),{currentCoversation:function(){var t=this;return this.currentId&&this.conversations?this.conversations.find(function(e){return e.id===t.currentId}):null}}),watch:{currentId:{handler:function(t){var e=this;t&&this.currentCoversation.queryMessages({limit:20}).then(function(t){e.$set(e,"messages",t)})},immediate:!0},messages:{handler:function(t){this.scrollBottom()},deep:!0,immediate:!0},currentCoversation:{handler:function(t,e){var n=this;t&&2!==t.members.length&&(e&&t.id===e.id||this.currentCoversation.on(m["Event"].MEMBERS_JOINED,this.membersjoinedEventHandler)),this.getting||t&&2!==t.members.length&&!this.members&&(this.getting=!0,this.getFriendsList({ids:t.members}).then(function(t){n.getting=!1;var e=[];t.forEach(function(t){var n=t[0].attributes,s=n.nickyname,i=n.avatar,a=n.uid;e.push({nickyname:s,avatar:i,uid:a})}),n.members=e}))},deep:!0,immediate:!0}},created:function(){this.eventBus.$on("new-message",this.handleEventBus)},beforeDestroy:function(){this.eventBus.$off("new-message",this.handleEventBus)},methods:Object(a["a"])({},Object(l["c"])(["addFriendInfo"]),Object(l["b"])(["getFriendsList","addFriends"]),{membersjoinedEventHandler:function(t){var e=this;this.getFriendsList({ids:t.members}).then(function(t){t.forEach(function(t){var n=t[0].attributes,s=n.nickyname,i=n.avatar,a=n.uid;e.members=e.members||[],e.members.push({nickyname:s,avatar:i,uid:a})})})},scrollBottom:function(){var t=this;this.$nextTick(function(){t.$refs.ul.scrollTop=t.$refs.ul.scrollHeight})},handleEventBus:function(t,e){e.id===this.currentId&&this.messages.push(t)},send:function(){var t=Object(E["a"])(regeneratorRuntime.mark(function t(){var e=this;return regeneratorRuntime.wrap(function(t){while(1)switch(t.prev=t.next){case 0:if(this.msg){t.next=2;break}return t.abrupt("return");case 2:this.currentCoversation.send(new m["TextMessage"](this.msg)).then(function(t){e.msg="",e.messages.push(t)}).catch(function(t){console.log(t)});case 3:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}(),getNickyname:function(t){return this.members.find(function(e){return e.uid===t})},onAdd:function(t){var e=this;if(!this.add){this.add=!0;var n=JSON.parse(JSON.stringify(this.userInfo.friends));n.indexOf(t)>-1||t===this.userInfo.uid?this.add=!1:(n.push(t),this.addFriends({friends:n,id:this.userInfo.id}).then(function(n){e.addFriendInfo(t),e.add=!1}))}},getAvatar:function(t){var e=this.members.find(function(e){return e.uid===t});return e.avatar}})}),V=B,T=(n("a0b5"),Object(C["a"])(V,j,x,!1,null,"62f85379",null));T.options.__file="dialog.vue";var N=T.exports,$=(n("9203"),{name:"Conversation",inject:["eventBus"],components:{xIcon:r["a"],eNav:y,eDialog:N},computed:Object(a["a"])({},Object(l["d"])({user:function(t){return t.user},userInfo:function(t){return t.userInfo},client:function(t){return t.client},currentId:function(t){return t.currentConversationId}})),methods:Object(a["a"])({},Object(l["c"])(["setUser","setUserInfo","setConversations","setClient"]),Object(l["b"])(["createUserInfo","getUserInfo","updateInfo","logout"]))}),F=$,A=(n("ad54"),Object(C["a"])(F,s,i,!1,null,"3ff04e59",null));A.options.__file="Conversation.vue";e["default"]=A.exports},"4ee4":function(t,e,n){},7804:function(t,e,n){},"81d6":function(t,e,n){"use strict";var s=n("7804"),i=n.n(s);i.a},a0b5:function(t,e,n){"use strict";var s=n("a79f"),i=n.n(s);i.a},a79f:function(t,e,n){},ad54:function(t,e,n){"use strict";var s=n("c856"),i=n.n(s);i.a},c856:function(t,e,n){},cd05:function(t,e,n){"use strict";var s=n("4ee4"),i=n.n(s);i.a}}]);
//# sourceMappingURL=chunk-2c584f5b.437f8a86.js.map